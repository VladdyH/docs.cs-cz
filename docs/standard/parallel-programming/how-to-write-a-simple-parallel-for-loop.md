---
title: "Postupy: Zápis jednoduché smyčky Parallel.For"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-standard
ms.tgt_pltfrm: 
ms.topic: article
dev_langs:
- csharp
- vb
helpviewer_keywords:
- Parallel.For, How to Write
- for loop, parallel construction in .NET
- parallel for loops, how to use
ms.assetid: 9029ba7f-a9d1-4526-8c84-c88716dba5d4
caps.latest.revision: "18"
author: rpetrusha
ms.author: ronpet
manager: wpickett
ms.openlocfilehash: ed621f41e76addde777b974732470fcfbc903563
ms.sourcegitcommit: 4f3fef493080a43e70e951223894768d36ce430a
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 11/21/2017
---
# <a name="how-to-write-a-simple-parallelfor-loop"></a><span data-ttu-id="702e7-102">Postupy: Zápis jednoduché smyčky Parallel.For</span><span class="sxs-lookup"><span data-stu-id="702e7-102">How to: Write a Simple Parallel.For Loop</span></span>
<span data-ttu-id="702e7-103">Toto téma obsahuje dva příklady, které ilustrují <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> metoda.</span><span class="sxs-lookup"><span data-stu-id="702e7-103">This topic contains two examples that illustrate the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="702e7-104">První používá <xref:System.Threading.Tasks.Parallel.For%28System.Int64%2CSystem.Int64%2CSystem.Action%7BSystem.Int64%7D%29?displayProperty=nameWithType> přetížení metody a druhý používá <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Action%7BSystem.Int32%7D%29?displayProperty=nameWithType> přetížení, dva nejjednodušší přetížení <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> metoda.</span><span class="sxs-lookup"><span data-stu-id="702e7-104">The first uses the <xref:System.Threading.Tasks.Parallel.For%28System.Int64%2CSystem.Int64%2CSystem.Action%7BSystem.Int64%7D%29?displayProperty=nameWithType> method overload, and the second uses the <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Action%7BSystem.Int32%7D%29?displayProperty=nameWithType> overload, the two simplest overloads of the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="702e7-105">Můžete použít tyto dvě přetížení <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> metoda, když není potřeba zrušit smyčky, rozdělit mimo iterace smyčky nebo udržovat žádné místní stav.</span><span class="sxs-lookup"><span data-stu-id="702e7-105">You can use these two overloads of the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method when you do not need to cancel the loop, break out of the loop iterations, or maintain any thread-local state.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="702e7-106">Tato dokumentace používá k definování delegátů v TPL lambda výrazy.</span><span class="sxs-lookup"><span data-stu-id="702e7-106">This documentation uses lambda expressions to define delegates in TPL.</span></span> <span data-ttu-id="702e7-107">Pokud nejste obeznámeni s výrazy lambda v jazyce C# nebo Visual Basic, přečtěte si téma [výrazy Lambda v PLINQ a TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="702e7-107">If you are not familiar with lambda expressions in C# or Visual Basic, see [Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span></span>  
  
 <span data-ttu-id="702e7-108">V prvním příkladu vypočítá velikost souborů v jednom adresáři.</span><span class="sxs-lookup"><span data-stu-id="702e7-108">The first example calculates the size of files in a single directory.</span></span> <span data-ttu-id="702e7-109">Druhou je výpočet součin dvou matice.</span><span class="sxs-lookup"><span data-stu-id="702e7-109">The second computes the product of two matrices.</span></span>  
  
## <a name="example"></a><span data-ttu-id="702e7-110">Příklad</span><span class="sxs-lookup"><span data-stu-id="702e7-110">Example</span></span>  
 <span data-ttu-id="702e7-111">V tomto příkladu je jednoduchého nástroje příkazového řádku, která by vypočítala celková velikost souborů v adresáři.</span><span class="sxs-lookup"><span data-stu-id="702e7-111">This example is a simple command-line utility that calculates the total size of files in a directory.</span></span> <span data-ttu-id="702e7-112">Očekává jako argument cestu jednoho adresářového a sestavy počtu a celkové velikosti souborů v tomto adresáři.</span><span class="sxs-lookup"><span data-stu-id="702e7-112">It expects a single directory path as an argument, and reports the number and total size of the files in that directory.</span></span> <span data-ttu-id="702e7-113">Po ověření, zda adresář existuje, použije <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> metodu pro vytvoření výčtu souborů v adresáři a určit jejich velikosti souborů.</span><span class="sxs-lookup"><span data-stu-id="702e7-113">After verifying that the directory exists, it uses the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method to enumerate the files in the directory and determine their file sizes.</span></span> <span data-ttu-id="702e7-114">Velikost každého souboru se pak přidá do `totalSize` proměnné.</span><span class="sxs-lookup"><span data-stu-id="702e7-114">Each file size is then added to the `totalSize` variable.</span></span> <span data-ttu-id="702e7-115">Všimněte si, že se přidání provádí volání <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> tak, aby se provádí přidání jako atomickou operaci.</span><span class="sxs-lookup"><span data-stu-id="702e7-115">Note that the addition is performed by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> so that the addition is performed as an atomic operation.</span></span> <span data-ttu-id="702e7-116">Jinak hodnota mohou zkuste aktualizovat více úloh `totalSize` proměnná současně.</span><span class="sxs-lookup"><span data-stu-id="702e7-116">Otherwise, multiple tasks could try to update the `totalSize` variable simultaneously.</span></span>  
  
 [!code-csharp[Conceptual.Parallel.For#1](../../../samples/snippets/csharp/VS_Snippets_CLR/conceptual.parallel.for/cs/for1.cs#1)]
 [!code-vb[Conceptual.Parallel.For#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR/conceptual.parallel.for/vb/for1.vb#1)]  
  
## <a name="example"></a><span data-ttu-id="702e7-117">Příklad</span><span class="sxs-lookup"><span data-stu-id="702e7-117">Example</span></span>  
 <span data-ttu-id="702e7-118">Tento příklad používá <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> metoda vypočítat součin dvou matice.</span><span class="sxs-lookup"><span data-stu-id="702e7-118">This example uses the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method to compute the product of two matrices.</span></span> <span data-ttu-id="702e7-119">Také ukazuje, jak používat <xref:System.Diagnostics.Stopwatch?displayProperty=nameWithType> třída porovnat výkon paralelní smyčky pomocí jiných paralelní smyčky.</span><span class="sxs-lookup"><span data-stu-id="702e7-119">It also shows how to use the <xref:System.Diagnostics.Stopwatch?displayProperty=nameWithType> class to compare the performance of a parallel loop with a non-parallel loop.</span></span> <span data-ttu-id="702e7-120">Všimněte si, že, protože to může generovat značný výstupu, příklad umožňuje výstup přesměrovat do souboru.</span><span class="sxs-lookup"><span data-stu-id="702e7-120">Note that, because it can generate a large volume of output, the example allows output to be redirected to a file.</span></span>  
  
 [!code-csharp[TPL_Parallel#01](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/simpleparallelfor.cs#01)]
 [!code-vb[TPL_Parallel#01](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/simpleparallelfor.vb#01)]  
  
 <span data-ttu-id="702e7-121">Při paralelním prováděním žádný kód, včetně smyčky, jeden důležité cílem je využít co nejvíce bez procesory přes paralelním prováděním do bodu, kde režijní náklady pro paralelní zpracování Neguje žádné výhody výkonu.</span><span class="sxs-lookup"><span data-stu-id="702e7-121">When parallelizing any code, including loops, one important goal is to utilize the processors as much as possible without over parallelizing to the point where the overhead for parallel processing negates any performance benefits.</span></span> <span data-ttu-id="702e7-122">V tomto konkrétním příkladu je paralelizovaná pouze vnější smyčku několika málo vzhledem k tomu, že není k dispozici hodně práce v informacích o vnitřní smyčky.</span><span class="sxs-lookup"><span data-stu-id="702e7-122">In this particular example, only the outer loop is parallelized because there is not very much work performed in the inner loop.</span></span> <span data-ttu-id="702e7-123">Kombinace malé množství práce a mezipaměti nežádoucí účinky může způsobit snížení výkonu ve vnořených paralelní smyčky.</span><span class="sxs-lookup"><span data-stu-id="702e7-123">The combination of a small amount of work and undesirable cache effects can result in performance degradation in nested parallel loops.</span></span> <span data-ttu-id="702e7-124">Vytváření paralelní smyčky vnější pouze tedy nejlepší způsob, jak zvýšit výhody souběžnosti u většiny systémů.</span><span class="sxs-lookup"><span data-stu-id="702e7-124">Therefore, parallelizing the outer loop only is the best way to maximize the benefits of concurrency on most systems.</span></span>  
  
## <a name="the-delegate"></a><span data-ttu-id="702e7-125">Delegát</span><span class="sxs-lookup"><span data-stu-id="702e7-125">The Delegate</span></span>  
 <span data-ttu-id="702e7-126">Třetí parametr funkce toto přetížení <xref:System.Threading.Tasks.Parallel.For%2A> je delegáta typu `Action<int>` v jazyce C# nebo `Action(Of Integer)` v jazyce Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="702e7-126">The third parameter of this overload of <xref:System.Threading.Tasks.Parallel.For%2A> is a delegate of type `Action<int>` in C# or `Action(Of Integer)` in Visual Basic.</span></span> <span data-ttu-id="702e7-127">`Action` Delegáta, zda má nula, jednu nebo parametry šestnáct typu vždy vrátí prázdnou hodnotu.</span><span class="sxs-lookup"><span data-stu-id="702e7-127">An `Action` delegate, whether it has zero, one or sixteen type parameters, always returns void.</span></span> <span data-ttu-id="702e7-128">V jazyce Visual Basic, chování `Action` je definovaná pomocí `Sub`.</span><span class="sxs-lookup"><span data-stu-id="702e7-128">In Visual Basic, the behavior of an `Action` is defined with a `Sub`.</span></span> <span data-ttu-id="702e7-129">Tento příklad používá k vytvoření delegát výrazu lambda, ale delegát můžete vytvořit také jiné způsoby.</span><span class="sxs-lookup"><span data-stu-id="702e7-129">The example uses a lambda expression to create the delegate, but you can create the delegate in other ways as well.</span></span> <span data-ttu-id="702e7-130">Další informace najdete v tématu [výrazy Lambda v PLINQ a TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="702e7-130">For more information, see [Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span></span>  
  
## <a name="the-iteration-value"></a><span data-ttu-id="702e7-131">Hodnota iterace</span><span class="sxs-lookup"><span data-stu-id="702e7-131">The Iteration Value</span></span>  
 <span data-ttu-id="702e7-132">Delegát používá jeden vstupní parametr, jehož hodnota je aktuální.</span><span class="sxs-lookup"><span data-stu-id="702e7-132">The delegate takes a single input parameter whose value is the current iteration.</span></span> <span data-ttu-id="702e7-133">Tuto hodnotu iterace poskytuje modulem runtime a jeho výchozí hodnota je index první prvek v segmentu (oddíl) zdroje, které jsou zpracovávány v aktuální vlákno.</span><span class="sxs-lookup"><span data-stu-id="702e7-133">This iteration value is supplied by the runtime and its starting value is the index of the first element on the segment (partition) of the source that is being processed on the current thread.</span></span>  
  
 <span data-ttu-id="702e7-134">Pokud potřebujete větší kontrolu nad úroveň souběžnosti, použijte jednu z přetížení, která přebírá <xref:System.Threading.Tasks.ParallelOptions?displayProperty=nameWithType> vstupní parametr, jako například: <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Threading.Tasks.ParallelOptions%2CSystem.Action%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%7D%29?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="702e7-134">If you require more control over the concurrency level, use one of the overloads that takes a <xref:System.Threading.Tasks.ParallelOptions?displayProperty=nameWithType> input parameter, such as: <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Threading.Tasks.ParallelOptions%2CSystem.Action%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%7D%29?displayProperty=nameWithType>.</span></span>  
  
## <a name="return-value-and-exception-handling"></a><span data-ttu-id="702e7-135">Vrátí hodnotu a zpracování výjimek</span><span class="sxs-lookup"><span data-stu-id="702e7-135">Return Value and Exception Handling</span></span>  
 <span data-ttu-id="702e7-136"><xref:System.Threading.Tasks.Parallel.For%2A>Vrátí <xref:System.Threading.Tasks.ParallelLoopResult?displayProperty=nameWithType> objektu po dokončení všech vláken.</span><span class="sxs-lookup"><span data-stu-id="702e7-136"><xref:System.Threading.Tasks.Parallel.For%2A> returns a <xref:System.Threading.Tasks.ParallelLoopResult?displayProperty=nameWithType> object when all threads have completed.</span></span> <span data-ttu-id="702e7-137">Tato vrátí hodnotu je užitečné, když chcete přestat nebo ukončování řádků pro cykly iterace ručně, protože <xref:System.Threading.Tasks.ParallelLoopResult> ukládá informace, jako jsou poslední iterace, který byl dokončen.</span><span class="sxs-lookup"><span data-stu-id="702e7-137">This return value is useful when you are stopping or breaking loop iteration manually, because the <xref:System.Threading.Tasks.ParallelLoopResult> stores information such as the last iteration that ran to completion.</span></span> <span data-ttu-id="702e7-138">Pokud na jednom vláken, dojde k jedné nebo několika výjimkám <xref:System.AggregateException?displayProperty=nameWithType> bude vyvolána.</span><span class="sxs-lookup"><span data-stu-id="702e7-138">If one or more exceptions occur on one of the threads, a <xref:System.AggregateException?displayProperty=nameWithType> will be thrown.</span></span>  
  
 <span data-ttu-id="702e7-139">V kódu v tomto příkladu návratová hodnota <xref:System.Threading.Tasks.Parallel.For%2A> nepoužívá.</span><span class="sxs-lookup"><span data-stu-id="702e7-139">In the code in this example, the return value of <xref:System.Threading.Tasks.Parallel.For%2A> is not used.</span></span>  
  
## <a name="analysis-and-performance"></a><span data-ttu-id="702e7-140">Analýzy a výkonu</span><span class="sxs-lookup"><span data-stu-id="702e7-140">Analysis and Performance</span></span>  
 <span data-ttu-id="702e7-141">Průvodce výkonu můžete zobrazit využití procesoru ve vašem počítači.</span><span class="sxs-lookup"><span data-stu-id="702e7-141">You can use the Performance Wizard to view CPU usage on your computer.</span></span> <span data-ttu-id="702e7-142">Stejně jako experimentu zvýšíte počet sloupců a řádků v matice.</span><span class="sxs-lookup"><span data-stu-id="702e7-142">As an experiment, increase the number of columns and rows in the matrices.</span></span> <span data-ttu-id="702e7-143">Větší matice, tím větší rozdíl mezi výkonem paralelní a sekvenční verzích výpočet.</span><span class="sxs-lookup"><span data-stu-id="702e7-143">The larger the matrices, the greater the performance difference between the parallel and sequential versions of the computation.</span></span> <span data-ttu-id="702e7-144">Při malém matice sekvenční verze bude rychlejší spustit z důvodu režijní náklady v nastavení paralelní smyčky.</span><span class="sxs-lookup"><span data-stu-id="702e7-144">When the matrix is small, the sequential version will run faster because of the overhead in setting up the parallel loop.</span></span>  
  
 <span data-ttu-id="702e7-145">Synchronní volání ke sdíleným prostředkům, jako jsou konzole nebo systému souborů, se výrazně snížit výkon paralelní smyčky.</span><span class="sxs-lookup"><span data-stu-id="702e7-145">Synchronous calls to shared resources, like the Console or the File System, will significantly degrade the performance of a parallel loop.</span></span> <span data-ttu-id="702e7-146">Při měření výkonu, pokuste se vyhnout volání, jako <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> v rámci smyčky.</span><span class="sxs-lookup"><span data-stu-id="702e7-146">When measuring performance, try to avoid calls such as <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> within the loop.</span></span>  
  
## <a name="compiling-the-code"></a><span data-ttu-id="702e7-147">Probíhá kompilace kódu</span><span class="sxs-lookup"><span data-stu-id="702e7-147">Compiling the Code</span></span>  
  
-   <span data-ttu-id="702e7-148">Zkopírujte a vložte tento kód do projektu sady Visual Studio 2010.</span><span class="sxs-lookup"><span data-stu-id="702e7-148">Copy and paste this code into a Visual Studio 2010 project.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="702e7-149">Viz také</span><span class="sxs-lookup"><span data-stu-id="702e7-149">See Also</span></span>  
 <xref:System.Threading.Tasks.Parallel.For%2A>  
 <xref:System.Threading.Tasks.Parallel.ForEach%2A>  
 [<span data-ttu-id="702e7-150">Datový paralelismus</span><span class="sxs-lookup"><span data-stu-id="702e7-150">Data Parallelism</span></span>](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)  
 [<span data-ttu-id="702e7-151">Paralelní programování</span><span class="sxs-lookup"><span data-stu-id="702e7-151">Parallel Programming</span></span>](../../../docs/standard/parallel-programming/index.md)
