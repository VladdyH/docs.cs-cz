---
title: "Postupy: Zápis smyčky Parallel.ForEach pomocí proměnných v místním vláknu"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-standard
ms.tgt_pltfrm: 
ms.topic: article
dev_langs:
- csharp
- vb
helpviewer_keywords:
- parallel foreach loop, how to use local state
ms.assetid: 24b10041-b30b-45cb-aa65-66cf568ca76d
caps.latest.revision: 
author: rpetrusha
ms.author: ronpet
manager: wpickett
ms.workload:
- dotnet
- dotnetcore
ms.openlocfilehash: 4c65edd8959cbf5f83e3353770f71cad130953d1
ms.sourcegitcommit: e7f04439d78909229506b56935a1105a4149ff3d
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 12/23/2017
---
# <a name="how-to-write-a-parallelforeach-loop-with-thread-local-variables"></a><span data-ttu-id="ac47c-102">Postupy: Zápis smyčky Parallel.ForEach pomocí proměnných v místním vláknu</span><span class="sxs-lookup"><span data-stu-id="ac47c-102">How to: Write a Parallel.ForEach Loop with Thread-Local Variables</span></span>
<span data-ttu-id="ac47c-103">Následující příklad znázorňuje, jakým způsobem lze zapisovat metodu <xref:System.Threading.Tasks.Parallel.ForEach%2A>, která používá místní proměnné vlákna.</span><span class="sxs-lookup"><span data-stu-id="ac47c-103">The following example shows how to write a <xref:System.Threading.Tasks.Parallel.ForEach%2A> method that uses thread-local variables.</span></span> <span data-ttu-id="ac47c-104">Při provedení smyčky <xref:System.Threading.Tasks.Parallel.ForEach%2A> dochází k rozdělení kolekce prostředků na několik oddílů.</span><span class="sxs-lookup"><span data-stu-id="ac47c-104">When a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop executes, it divides its source collection into multiple partitions.</span></span> <span data-ttu-id="ac47c-105">Jednotlivé oddíly obdrží vlastní kopii „místní proměnné vlákna“.</span><span class="sxs-lookup"><span data-stu-id="ac47c-105">Each partition will get its own copy of the "thread-local" variable.</span></span> <span data-ttu-id="ac47c-106">(Termín „místní proměnné vlákna“ je mírně nepřesný, protože v některých případech mohou být na stejném vlákně spuštěny dva oddíly.)</span><span class="sxs-lookup"><span data-stu-id="ac47c-106">(The term "thread-local" is slightly inaccurate here, because in some cases two partitions may run on the same thread.)</span></span>  
  
 <span data-ttu-id="ac47c-107">Kód a parametry uvedené v tomto příkladu se velmi podobají příslušné metodě <xref:System.Threading.Tasks.Parallel.For%2A>.</span><span class="sxs-lookup"><span data-stu-id="ac47c-107">The code and parameters in this example closely resemble the corresponding <xref:System.Threading.Tasks.Parallel.For%2A> method.</span></span> <span data-ttu-id="ac47c-108">Další informace najdete v tématu [postupy: zápis smyčky Parallel.For pomocí proměnných Thread-Local](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md).</span><span class="sxs-lookup"><span data-stu-id="ac47c-108">For more information, see [How to: Write a Parallel.For Loop with Thread-Local Variables](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md).</span></span>  
  
 <span data-ttu-id="ac47c-109">Pro použití v místní proměnné <xref:System.Threading.Tasks.Parallel.ForEach%2A> smyčky, musí volat jeden z přetížení metody, která přebírá dva parametry typu.</span><span class="sxs-lookup"><span data-stu-id="ac47c-109">To use a thread-local variable in a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop, you must call one of the method overloads that takes two type parameters.</span></span> <span data-ttu-id="ac47c-110">První parametr typu `TSource`, určuje typ source element a druhý parametr typu `TLocal`, určuje typ místní proměnné.</span><span class="sxs-lookup"><span data-stu-id="ac47c-110">The first type parameter, `TSource`, specifies the type of the source element, and the second type parameter, `TLocal`, specifies the type of the thread-local variable.</span></span>  
  
## <a name="example"></a><span data-ttu-id="ac47c-111">Příklad</span><span class="sxs-lookup"><span data-stu-id="ac47c-111">Example</span></span>  
 <span data-ttu-id="ac47c-112">Následující příklad volání <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> přetížení výpočetní součet pole jeden milión elementů.</span><span class="sxs-lookup"><span data-stu-id="ac47c-112">The following example calls <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> overload to compute the sum of an array of one million elements.</span></span> <span data-ttu-id="ac47c-113">Toto přetížení má čtyři parametry:</span><span class="sxs-lookup"><span data-stu-id="ac47c-113">This overload has four parameters:</span></span>  
  
-   <span data-ttu-id="ac47c-114">`source`, což je zdroj dat.</span><span class="sxs-lookup"><span data-stu-id="ac47c-114">`source`, which is the data source.</span></span> <span data-ttu-id="ac47c-115">Musí implementovat <xref:System.Collections.Generic.IEnumerable%601>.</span><span class="sxs-lookup"><span data-stu-id="ac47c-115">It must implement <xref:System.Collections.Generic.IEnumerable%601>.</span></span> <span data-ttu-id="ac47c-116">Zdroj dat v našem příkladu je člen jeden milión `IEnumerable<Int32>` objekt vrácený <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType> metoda.</span><span class="sxs-lookup"><span data-stu-id="ac47c-116">The data source in our example is the one million member `IEnumerable<Int32>` object returned by the <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType> method.</span></span>  
  
-   <span data-ttu-id="ac47c-117">`localInit`, nebo funkci, která inicializuje místní proměnné.</span><span class="sxs-lookup"><span data-stu-id="ac47c-117">`localInit`, or the function that initializes the thread-local variable.</span></span> <span data-ttu-id="ac47c-118">Tato funkce je volána jednou pro každý oddíl, ve kterém <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> provede operaci.</span><span class="sxs-lookup"><span data-stu-id="ac47c-118">This function is called once for each partition in which the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> operation executes.</span></span> <span data-ttu-id="ac47c-119">Náš příklad inicializuje místní proměnné na hodnotu nula.</span><span class="sxs-lookup"><span data-stu-id="ac47c-119">Our example initializes the thread-local variable to zero.</span></span>  
  
-   <span data-ttu-id="ac47c-120">`body`, <xref:System.Func%604> je vyvolané paralelní smyčky v každé iteraci smyčky.</span><span class="sxs-lookup"><span data-stu-id="ac47c-120">`body`, a <xref:System.Func%604> that is invoked by the parallel loop on each iteration of the loop.</span></span> <span data-ttu-id="ac47c-121">Podpis je `Func\<TSource, ParallelLoopState, TLocal, TLocal>`.</span><span class="sxs-lookup"><span data-stu-id="ac47c-121">Its signature is `Func\<TSource, ParallelLoopState, TLocal, TLocal>`.</span></span> <span data-ttu-id="ac47c-122">Zadejte kód pro delegáta a předá smyčky vstupní parametry, které jsou:</span><span class="sxs-lookup"><span data-stu-id="ac47c-122">You supply the code for the delegate, and the loop passes in the input parameters, which are:</span></span>  
  
    -   <span data-ttu-id="ac47c-123">Aktuální elementu <xref:System.Collections.Generic.IEnumerable%601>.</span><span class="sxs-lookup"><span data-stu-id="ac47c-123">The current element of the <xref:System.Collections.Generic.IEnumerable%601>.</span></span>  
  
    -   <span data-ttu-id="ac47c-124">A <xref:System.Threading.Tasks.ParallelLoopState> proměnné používané v kódu tohoto delegáta pro zjištění stavu smyčky.</span><span class="sxs-lookup"><span data-stu-id="ac47c-124">A <xref:System.Threading.Tasks.ParallelLoopState> variable that you can use in your delegate's code to examine the state of the loop.</span></span>  
  
    -   <span data-ttu-id="ac47c-125">Místní proměnná.</span><span class="sxs-lookup"><span data-stu-id="ac47c-125">The thread-local variable.</span></span>  
  
     <span data-ttu-id="ac47c-126">Delegát vrátí místní proměnné, který se potom předá do další iterace smyčky, který se spustí v konkrétní oddílu.</span><span class="sxs-lookup"><span data-stu-id="ac47c-126">Your delegate returns the thread-local variable, which is then passed to the next iteration of the loop that executes in that particular partition.</span></span> <span data-ttu-id="ac47c-127">Každý oddíl smyčky udržuje samostatnou instanci této proměnné.</span><span class="sxs-lookup"><span data-stu-id="ac47c-127">Each loop partition maintains a separate instance of this variable.</span></span>  
  
     <span data-ttu-id="ac47c-128">V příkladu delegát přidá do místní proměnné, který udržuje spuštěný hodnotu každý celé číslo celkový počet hodnot prvků celé číslo v oddílu.</span><span class="sxs-lookup"><span data-stu-id="ac47c-128">In the example, the delegate adds the value of each integer to the thread-local variable, which maintains a running total of the values of the integer elements in that partition.</span></span>  
  
-   <span data-ttu-id="ac47c-129">`localFinally`, `Action<TLocal>` delegáta, který <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> vyvolá po dokončení opakování operace v každém oddílu.</span><span class="sxs-lookup"><span data-stu-id="ac47c-129">`localFinally`, an `Action<TLocal>` delegate that the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> invokes when the looping operations in each partition have completed.</span></span> <span data-ttu-id="ac47c-130"><xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> Metoda předává vaše `Action<TLocal>` delegáta konečná hodnota místní proměnné pro tuto přístup z více vláken (nebo smyčky oddílu), a zadejte kód, který provádí požadované akce pro kombinování výsledek z tohoto oddílu s výsledky z jiných oddílů.</span><span class="sxs-lookup"><span data-stu-id="ac47c-130">The <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> method passes your `Action<TLocal>` delegate the final value of the thread-local variable for this thread (or loop partition), and you provide the code that performs the required action for combining the result from this partition with the results from the other partitions.</span></span> <span data-ttu-id="ac47c-131">Tento delegát lze vyvolat souběžně s několika úkoly.</span><span class="sxs-lookup"><span data-stu-id="ac47c-131">This delegate can be invoked concurrently by multiple tasks.</span></span> <span data-ttu-id="ac47c-132">Z toho důvodu se používá v příkladu <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> k synchronizaci přístup k `total` proměnné.</span><span class="sxs-lookup"><span data-stu-id="ac47c-132">Because of this, the example uses the <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> method to synchronize access to the `total` variable.</span></span> <span data-ttu-id="ac47c-133">Vzhledem k tomu, že delegát je typu <xref:System.Action%601>, neexistuje žádná návratová hodnota.</span><span class="sxs-lookup"><span data-stu-id="ac47c-133">Because the delegate type is an <xref:System.Action%601>, there is no return value.</span></span>  
  
 [!code-csharp[TPL_Parallel#04](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/foreachthreadlocal.cs#04)]
 [!code-vb[TPL_Parallel#04](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/foreachthreadlocal.vb#04)]  
  
## <a name="see-also"></a><span data-ttu-id="ac47c-134">Viz také</span><span class="sxs-lookup"><span data-stu-id="ac47c-134">See Also</span></span>  
 [<span data-ttu-id="ac47c-135">Datový paralelismus</span><span class="sxs-lookup"><span data-stu-id="ac47c-135">Data Parallelism</span></span>](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)  
 [<span data-ttu-id="ac47c-136">Postupy: Zápis smyčky Parallel.For pomocí proměnných v místním vláknu</span><span class="sxs-lookup"><span data-stu-id="ac47c-136">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md)  
 [<span data-ttu-id="ac47c-137">Výrazy lambda v PLINQ a TPL</span><span class="sxs-lookup"><span data-stu-id="ac47c-137">Lambda Expressions in PLINQ and TPL</span></span>](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)
