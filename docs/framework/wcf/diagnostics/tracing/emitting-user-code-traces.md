---
title: "Generování trasování v uživatelském kódu"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-clr
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: fa54186a-8ffa-4332-b0e7-63867126fd49
caps.latest.revision: "9"
author: Erikre
ms.author: erikre
manager: erikre
ms.openlocfilehash: d743ae68955bba844f84fed71047d9331fd349af
ms.sourcegitcommit: bd1ef61f4bb794b25383d3d72e71041a5ced172e
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 10/18/2017
---
# <a name="emitting-user-code-traces"></a><span data-ttu-id="80cc1-102">Generování trasování v uživatelském kódu</span><span class="sxs-lookup"><span data-stu-id="80cc1-102">Emitting User-Code Traces</span></span>
<span data-ttu-id="80cc1-103">Kromě povolení trasování v konfiguraci ke shromažďování dat instrumentace generované [!INCLUDE[indigo1](../../../../../includes/indigo1-md.md)], můžete také generování trasování v uživatelském kódu prostřednictvím kódu programu.</span><span class="sxs-lookup"><span data-stu-id="80cc1-103">In addition to enabling tracing in configuration to collect instrumentation data generated by [!INCLUDE[indigo1](../../../../../includes/indigo1-md.md)], you can also emit traces programmatically in user code.</span></span> <span data-ttu-id="80cc1-104">Tímto způsobem můžete vytvořit proaktivně instrumentace data, která můžete zobrazit později pro účely diagnostiky.</span><span class="sxs-lookup"><span data-stu-id="80cc1-104">In this way, you can proactively create instrumentation data that you can peruse later for diagnostic purpose.</span></span> <span data-ttu-id="80cc1-105">Toto téma popisuje, jak můžete to provést.</span><span class="sxs-lookup"><span data-stu-id="80cc1-105">This topic discusses how you can do this.</span></span>  
  
 <span data-ttu-id="80cc1-106">Kromě toho [rozšíření trasování](../../../../../docs/framework/wcf/samples/extending-tracing.md) ukázka zahrnuje všechny kód ukázáno v následujících částech.</span><span class="sxs-lookup"><span data-stu-id="80cc1-106">In addition, the [Extending Tracing](../../../../../docs/framework/wcf/samples/extending-tracing.md) sample includes all the code demonstrated in the following sections.</span></span>  
  
## <a name="creating-a-trace-source"></a><span data-ttu-id="80cc1-107">Vytváření zdroje trasování</span><span class="sxs-lookup"><span data-stu-id="80cc1-107">Creating a Trace Source</span></span>  
 <span data-ttu-id="80cc1-108">Následující kód slouží k vytvoření zdroj trasování uživatele.</span><span class="sxs-lookup"><span data-stu-id="80cc1-108">You can use the following code to create a user trace source.</span></span>  
  
```  
TraceSource ts = new TraceSource("myUserTraceSource");  
```  
  
## <a name="creating-activities"></a><span data-ttu-id="80cc1-109">Vytvoření aktivity</span><span class="sxs-lookup"><span data-stu-id="80cc1-109">Creating Activities</span></span>  
 <span data-ttu-id="80cc1-110">Aktivity jsou logické jednotky zpracování.</span><span class="sxs-lookup"><span data-stu-id="80cc1-110">Activities are logical unit of processing.</span></span> <span data-ttu-id="80cc1-111">Můžete vytvořit jednu aktivitu pro každou hlavní výpočetní jednotky, ve kterém chcete trasování do seskupeny dohromady.</span><span class="sxs-lookup"><span data-stu-id="80cc1-111">You can create one activity for each major processing unit in which you want traces to be grouped together.</span></span> <span data-ttu-id="80cc1-112">Můžete například vytvořit jednu aktivitu pro každý požadavek pro službu.</span><span class="sxs-lookup"><span data-stu-id="80cc1-112">For example, you can create one activity for each request to the service.</span></span> <span data-ttu-id="80cc1-113">Uděláte to tak, proveďte následující kroky.</span><span class="sxs-lookup"><span data-stu-id="80cc1-113">To do so, perform the following steps.</span></span>  
  
1.  <span data-ttu-id="80cc1-114">ID aktivity a uložte v oboru.</span><span class="sxs-lookup"><span data-stu-id="80cc1-114">Save the activity ID in scope.</span></span>  
  
2.  <span data-ttu-id="80cc1-115">Vytvoření nového ID aktivity.</span><span class="sxs-lookup"><span data-stu-id="80cc1-115">Create a new activity ID.</span></span>  
  
3.  <span data-ttu-id="80cc1-116">Přenos z aktivity v oboru do nového, nastavte novou aktivitu v oboru a emitování spuštění trasování pro danou aktivitu.</span><span class="sxs-lookup"><span data-stu-id="80cc1-116">Transfer from the activity in scope to the new one, set the new activity in scope and emit a start trace for that activity.</span></span>  
  
 <span data-ttu-id="80cc1-117">Následující kód ukazuje, jak to provést.</span><span class="sxs-lookup"><span data-stu-id="80cc1-117">The following code demonstrates how to do this.</span></span>  
  
```  
Guid oldID = Trace.CorrelationManager.ActivityId;  
Guid traceID = Guid.NewGuid();  
ts.TraceTransfer(0, "transfer", traceID);  
Trace.CorrelationManager.ActivityId = traceID; // Trace is static  
ts.TraceEvent(TraceEventType.Start, 0, "Add request");  
```  
  
## <a name="emitting-traces-within-a-user-activity"></a><span data-ttu-id="80cc1-118">Generování trasování v rámci aktivity uživatelů</span><span class="sxs-lookup"><span data-stu-id="80cc1-118">Emitting Traces within a User Activity</span></span>  
 <span data-ttu-id="80cc1-119">Následující kód vysílá trasování v rámci aktivity uživatelů.</span><span class="sxs-lookup"><span data-stu-id="80cc1-119">The following code emits traces within a user activity.</span></span>  
  
```  
double value1 = 100.00D;  
double value2 = 15.99D;  
ts.TraceInformation("Client sends message to Add " + value1 + ", " + value2);  
double result = client.Add(value1, value2);  
ts.TraceInformation("Client receives Add response '" + result + "'");  
```  
  
## <a name="stopping-the-activities"></a><span data-ttu-id="80cc1-120">Zastavení aktivity</span><span class="sxs-lookup"><span data-stu-id="80cc1-120">Stopping the Activities</span></span>  
 <span data-ttu-id="80cc1-121">K zastavení aktivity, přeneste zpět do původní aktivity, zastavte id aktuální aktivity a obnovit původní id aktivity v oboru.</span><span class="sxs-lookup"><span data-stu-id="80cc1-121">To stop the activities, transfer back to the old activity, stop the current activity id, and reset the old activity id in scope.</span></span>  
  
 <span data-ttu-id="80cc1-122">Následující kód ukazuje, jak to provést.</span><span class="sxs-lookup"><span data-stu-id="80cc1-122">The following code demonstrates how to do this.</span></span>  
  
```  
ts.TraceTransfer(0, "transfer", oldID);  
ts.TraceEvent(TraceEventType.Stop, 0, "Add request");  
Trace.CorrelationManager.ActivityId = oldID;  
```  
  
## <a name="propagating-the-activity-id-to-a-service"></a><span data-ttu-id="80cc1-123">Šíření ID aktivity služby</span><span class="sxs-lookup"><span data-stu-id="80cc1-123">Propagating the Activity ID to A Service</span></span>  
 <span data-ttu-id="80cc1-124">Pokud nastavíte `propagateActivity` atribut `true` pro `System.ServiceModel` zdroj trasování v konfiguraci klient a služba souborů, služba zpracování dojde k žádosti přidat do stejné aktivity, jako je definována v klientovi.</span><span class="sxs-lookup"><span data-stu-id="80cc1-124">If you set the `propagateActivity` attribute to `true` for the `System.ServiceModel` trace source in both the client and service configuration files, the service processing for the Add request occurs in the same activity as the one defined in the client.</span></span> <span data-ttu-id="80cc1-125">Pokud službu definuje vlastní aktivity a přenosy, služba trasování se nezobrazí v aktivitě klienta rozšířen.</span><span class="sxs-lookup"><span data-stu-id="80cc1-125">If the service defines its own activities and transfers, the service traces do not appear in the client-propagated activity.</span></span> <span data-ttu-id="80cc1-126">Místo toho se v aktivitě korelační pomocí přenosu trasování na aktivitu, jejíž ID je rozšířena klientem.</span><span class="sxs-lookup"><span data-stu-id="80cc1-126">Instead, they appear in an activity correlated by transfer traces to the activity whose ID is propagated by the client.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="80cc1-127">Pokud `propagateActivity` je atribut nastaven na `true` na klienta a služby, vedlejším aktivity v rámci operace služby je nastavený [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)].</span><span class="sxs-lookup"><span data-stu-id="80cc1-127">If the `propagateActivity` attribute is set to `true` on both the client and service, the ambient activity in the operation scope of the service is set by [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)].</span></span>  
  
 <span data-ttu-id="80cc1-128">Následující kód vám pomůže zkontrolovat, zda byl nastaven aktivitu v oboru podle [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)].</span><span class="sxs-lookup"><span data-stu-id="80cc1-128">You can use the following code to check whether an activity was set in scope by [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)].</span></span>  
  
```  
// Check if an activity was set in scope by WCF, if it was   
// propagated from the client. If not, ( ambient activity is   
// equal to Guid.Empty), create a new one.  
if(Trace.CorrelationManager.ActivityId == Guid.Empty)  
{  
    Guid newGuid = Guid.NewGuid();  
    Trace.CorrelationManager.ActivityId = newGuid;  
}  
// Emit your Start trace.  
ts.TraceEvent(TraceEventType.Start, 0, "Add Activity");  
  
// Emit the processing traces for that request.  
serviceTs.TraceInformation("Service receives Add "   
                            + n1 + ", " + n2);  
// double result = n1 + n2;  
serviceTs.TraceInformation("Service sends Add result" + result);  
  
// Emit the Stop trace and exit the method scope.  
ts.TraceEvent(TraceEventType.Stop, 0, "Add Activity");  
// return result;  
```  
  
## <a name="tracing-exceptions-thrown-in-code"></a><span data-ttu-id="80cc1-129">Trasování výjimky vydané v kódu</span><span class="sxs-lookup"><span data-stu-id="80cc1-129">Tracing Exceptions Thrown in Code</span></span>  
 <span data-ttu-id="80cc1-130">Pokud je vyvolána výjimka v kódu, můžete také trasování výjimky na úrovni upozornění nebo si pomocí následujícího kódu.</span><span class="sxs-lookup"><span data-stu-id="80cc1-130">When you throw an exception in code, you can also trace the exception at Warning level or up using the following code.</span></span>  
  
```  
ts.TraceEvent(TraceEventType.Warning, 0, "Throwing exception " + "exceptionMessage");  
```  
  
## <a name="viewing-user-traces-in-the-service-trace-viewer-tool"></a><span data-ttu-id="80cc1-131">Zobrazení trasování uživatele v nástroji Prohlížeč trasování pro služby</span><span class="sxs-lookup"><span data-stu-id="80cc1-131">Viewing User Traces in the Service Trace Viewer Tool</span></span>  
 <span data-ttu-id="80cc1-132">Tato část obsahuje snímky obrazovky trasování generované systémem [rozšíření trasování](../../../../../docs/framework/wcf/samples/extending-tracing.md) ukázkové, při zobrazení pomocí [nástroj Prohlížeč trasování služeb (SvcTraceViewer.exe)](../../../../../docs/framework/wcf/service-trace-viewer-tool-svctraceviewer-exe.md).</span><span class="sxs-lookup"><span data-stu-id="80cc1-132">This section contains screenshots of traces generated by running the [Extending Tracing](../../../../../docs/framework/wcf/samples/extending-tracing.md) sample, when viewed using the [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../../../../docs/framework/wcf/service-trace-viewer-tool-svctraceviewer-exe.md).</span></span>  
  
 <span data-ttu-id="80cc1-133">V následujícím diagramu je vybraná aktivita "žádostí Přidat" předtím vytvořili na levém panelu.</span><span class="sxs-lookup"><span data-stu-id="80cc1-133">In the following diagram, the "Add request" activity created previously is selected on the left panel.</span></span> <span data-ttu-id="80cc1-134">Zobrazí se aktivitách tři další matematické operace (dělit, Subtract, násobkem) které tvoří program klienta aplikace.</span><span class="sxs-lookup"><span data-stu-id="80cc1-134">It is listed with three other Math operation activities (Divide, Subtract, Multiply) that constitute the application client program.</span></span> <span data-ttu-id="80cc1-135">Kód uživatele nemá definovánu jednu novou aktivitu, pro každou operaci izolovat potenciální chyby výskytů na jiné požadavky.</span><span class="sxs-lookup"><span data-stu-id="80cc1-135">The user code has defined one new activity for each operation to isolate potential error occurrences in different requests.</span></span>  
  
 <span data-ttu-id="80cc1-136">K předvedení použití přenosů [rozšíření trasování](../../../../../docs/framework/wcf/samples/extending-tracing.md) ukázce kalkulačky aktivity, který zapouzdřuje čtyři operace žádosti, které se také vytvoří.</span><span class="sxs-lookup"><span data-stu-id="80cc1-136">To demonstrate the use of transfers in the [Extending Tracing](../../../../../docs/framework/wcf/samples/extending-tracing.md) sample, a Calculator activity that encapsulates the four operation requests is also created.</span></span> <span data-ttu-id="80cc1-137">Pro každý požadavek, je přenos a zpět z aktivity kalkulačky pro aktivitu žádosti (trasování je zvýrazněn v horním pravém panelu na obrázku).</span><span class="sxs-lookup"><span data-stu-id="80cc1-137">For each request, there is a transfer back and forth from the Calculator activity to the request activity (trace is highlighted in the upper right panel in the figure).</span></span>  
  
 <span data-ttu-id="80cc1-138">Když vyberete aktivitu na levém panelu, trasování začleněn sám v této aktivity se zobrazí v horním pravém panelu.</span><span class="sxs-lookup"><span data-stu-id="80cc1-138">When you select an activity on the left panel, the traces included by this activity are shown on the upper right panel.</span></span> <span data-ttu-id="80cc1-139">Pokud `propagateActivity` je `true` na každý koncový bod v cestě požadavku trasování v aktivitu žádosti jsou ze všech procesů, které jsou součástí požadavku.</span><span class="sxs-lookup"><span data-stu-id="80cc1-139">If `propagateActivity` is `true` at every endpoint in the request path, traces in the request activity are from all processes that participate in the request.</span></span> <span data-ttu-id="80cc1-140">V tomto příkladu se zobrazí trasování z klienta a služby ve sloupci 4. v panelu.</span><span class="sxs-lookup"><span data-stu-id="80cc1-140">In this example, you can see traces from both the client and service in the 4th column in the panel.</span></span>  
  
 <span data-ttu-id="80cc1-141">Tato aktivita se zobrazí následující pořadí zpracování:</span><span class="sxs-lookup"><span data-stu-id="80cc1-141">This activity shows the following order of processing:</span></span>  
  
1.  <span data-ttu-id="80cc1-142">Klient odešle zprávu do přidat.</span><span class="sxs-lookup"><span data-stu-id="80cc1-142">Client sends message to Add.</span></span>  
  
2.  <span data-ttu-id="80cc1-143">Služba přijímá přidat zprávu požadavku.</span><span class="sxs-lookup"><span data-stu-id="80cc1-143">Service receives Add request message.</span></span>  
  
3.  <span data-ttu-id="80cc1-144">Služba odešle odpověď přidat.</span><span class="sxs-lookup"><span data-stu-id="80cc1-144">Service sends Add response.</span></span>  
  
4.  <span data-ttu-id="80cc1-145">Klient obdrží odpověď přidat.</span><span class="sxs-lookup"><span data-stu-id="80cc1-145">Client receives Add response.</span></span>  
  
 <span data-ttu-id="80cc1-146">Všechny tyto trasování byly vygenerované na úrovni informace.</span><span class="sxs-lookup"><span data-stu-id="80cc1-146">All these traces were emitted at Information level.</span></span> <span data-ttu-id="80cc1-147">Kliknutím na trasování v pravém panelu zobrazuje podrobnosti o této trasování v pravém panelu.</span><span class="sxs-lookup"><span data-stu-id="80cc1-147">Clicking a trace in the upper-right panel shows the details of that trace in the lower-right panel.</span></span>  
  
 <span data-ttu-id="80cc1-148">V následujícím diagramu vidíte také přenos trasování od a do aktivity kalkulačky, jakož i dvě dvojice spuštění a zastavení trasování za aktivitu žádosti o, jeden pro klienta a jeden pro službu (jeden pro každý zdroj trasování).</span><span class="sxs-lookup"><span data-stu-id="80cc1-148">In the following diagram, we also see transfer traces from and to the Calculator activity, as well as two pairs of Start and Stop traces per request activity, one for the client and one for the service (one for each trace source).</span></span>  
  
 <span data-ttu-id="80cc1-149">![Prohlížeč trasování: Generování č. 45; & uživatelského kódu trasování](../../../../../docs/framework/wcf/diagnostics/tracing/media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd")</span><span class="sxs-lookup"><span data-stu-id="80cc1-149">![Trace Viewer: Emitting User&#45;code traces](../../../../../docs/framework/wcf/diagnostics/tracing/media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd")</span></span>  
<span data-ttu-id="80cc1-150">Seznam aktivit podle času vytvoření (levém panelu) a jejich vnořené aktivity (pravém panelu)</span><span class="sxs-lookup"><span data-stu-id="80cc1-150">List of activities by creation time (left panel) and their nested activities (upper-right panel)</span></span>  
  
 <span data-ttu-id="80cc1-151">Pokud kódu služby vyvolá výjimku, která způsobuje, že klient má být vyvolána také (například když klient neobdržela odpověď na žádost), jak služba a klient upozornění nebo chybové zprávy objevit ve stejné aktivitě pro přímé korelace.</span><span class="sxs-lookup"><span data-stu-id="80cc1-151">If the service code throws an exception that causes the client to throw as well (for example, when the client did not get the response to its request), both the service and client warning or error messages occur in the same activity for direct correlation.</span></span> <span data-ttu-id="80cc1-152">V následujícím diagramu službu vyvolá výjimku, která stavy "služba odmítá zpracovat tento požadavek v uživatelském kódu."</span><span class="sxs-lookup"><span data-stu-id="80cc1-152">In the following diagram, the service throws an exception that states "The service refuses to process this request in user code."</span></span> <span data-ttu-id="80cc1-153">Klient také vyvolá výjimku, která stavy "server nemohl zpracovat požadavek z důvodu vnitřní chyby."</span><span class="sxs-lookup"><span data-stu-id="80cc1-153">The client also throws an exception that states "The server was unable to process the request due to an internal error."</span></span>  
  
 <span data-ttu-id="80cc1-154">![Použití prohlížeče trasování pro vydávání č. 45; & uživatelského kódu trasování](../../../../../docs/framework/wcf/diagnostics/tracing/media/e2etrace2.gif "e2eTrace2")</span><span class="sxs-lookup"><span data-stu-id="80cc1-154">![Using Trace Viewer to emit user&#45;code traces](../../../../../docs/framework/wcf/diagnostics/tracing/media/e2etrace2.gif "e2eTrace2")</span></span>  
<span data-ttu-id="80cc1-155">Chyby napříč koncovými body pro daný požadavek se zobrazují ve stejné aktivitě, pokud byla rozšířena id aktivity žádosti</span><span class="sxs-lookup"><span data-stu-id="80cc1-155">Errors across endpoints for a given request appear in the same activity if the request activity id was propagated</span></span>  
  
 <span data-ttu-id="80cc1-156">Dvojitým kliknutím násobkem aktivita na levém panelu se zobrazí následující graf s trasování pro násobení aktivity související se situací jednotlivých procesů.</span><span class="sxs-lookup"><span data-stu-id="80cc1-156">Double-clicking the Multiply activity on the left panel shows the following graph, with the traces for the Multiply activity for each process involved.</span></span> <span data-ttu-id="80cc1-157">Vidíme, že upozornění nejdřív došlo k chybě na službu (vyvolána výjimka), která následuje upozornění a chyby v klientovi protože nebylo možné zpracovat žádost.</span><span class="sxs-lookup"><span data-stu-id="80cc1-157">We can see a warning first occurred at the service (exception thrown), which is followed by warnings and errors on the client because the request could not be processed.</span></span> <span data-ttu-id="80cc1-158">Proto jsme implikují příčinnou chyba vztah mezi koncovými body a odvodí hlavní příčinu chyby.</span><span class="sxs-lookup"><span data-stu-id="80cc1-158">Therefore, we can imply the causal error relationship between endpoints and derive the root cause of the error.</span></span>  
  
 <span data-ttu-id="80cc1-159">![Použití prohlížeče trasování pro vydávání č. 45; & uživatelského kódu trasování](../../../../../docs/framework/wcf/diagnostics/tracing/media/e2etrace3.gif "e2eTrace3")</span><span class="sxs-lookup"><span data-stu-id="80cc1-159">![Using Trace Viewer to emit user&#45;code traces](../../../../../docs/framework/wcf/diagnostics/tracing/media/e2etrace3.gif "e2eTrace3")</span></span>  
<span data-ttu-id="80cc1-160">Zobrazení grafu chybě korelace</span><span class="sxs-lookup"><span data-stu-id="80cc1-160">Graph view of error correlation</span></span>  
  
 <span data-ttu-id="80cc1-161">Pokud chcete získat předchozí trasování, nastaví `ActivityTracing` pro trasování zdrojů uživatele a `propagateActivity=true` pro `System.ServiceModel` zdroj trasování.</span><span class="sxs-lookup"><span data-stu-id="80cc1-161">To obtain the previous traces, we set `ActivityTracing` for the user trace sources and `propagateActivity=true` for the `System.ServiceModel` trace source.</span></span> <span data-ttu-id="80cc1-162">Jsme nenastavili `ActivityTracing` pro `System.ServiceModel` zdroj trasování povolit uživatelský kód pro rozšíření aktivity kódu uživatele.</span><span class="sxs-lookup"><span data-stu-id="80cc1-162">We did not set `ActivityTracing` for the `System.ServiceModel` trace source to enable user code to user code activity propagation.</span></span> <span data-ttu-id="80cc1-163">(Pokud ServiceModel trasování aktivit je zapnutý, ID aktivity definované v klientovi není rozšířen úplně do kódu uživatele služby; Přenosy, ale korelovat aktivity kód klienta a služby uživatele do mezilehlých [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)] aktivity.)</span><span class="sxs-lookup"><span data-stu-id="80cc1-163">(When ServiceModel activity tracing is on, the activity ID defined in the client is not propagated all the way to the service user code; Transfers, however, correlate the client and service user code activities to the intermediate [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)] activities.)</span></span>  
  
 <span data-ttu-id="80cc1-164">Definování aktivity a šíření ID aktivity a umožňuje nám k provedení korelace přímé chyba napříč koncovými body.</span><span class="sxs-lookup"><span data-stu-id="80cc1-164">Defining activities and propagating the activity ID enables us to perform direct error correlation across endpoints.</span></span> <span data-ttu-id="80cc1-165">Tímto způsobem jsme rychleji najít hlavní příčinu chyby.</span><span class="sxs-lookup"><span data-stu-id="80cc1-165">In this way, we can locate the root cause of an error more quickly.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="80cc1-166">Viz také</span><span class="sxs-lookup"><span data-stu-id="80cc1-166">See Also</span></span>  
 [<span data-ttu-id="80cc1-167">Rozšíření trasování</span><span class="sxs-lookup"><span data-stu-id="80cc1-167">Extending Tracing</span></span>](../../../../../docs/framework/wcf/samples/extending-tracing.md)
