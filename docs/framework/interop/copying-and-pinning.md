---
title: "Kopírování a přichycování"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-clr
ms.tgt_pltfrm: 
ms.topic: article
helpviewer_keywords:
- pinning, interop marshaling
- copying, interop marshaling
- interop marshaling, copying
- interop marshaling, pinning
ms.assetid: 0059f576-e460-4e70-b257-668870e420b8
caps.latest.revision: "8"
author: rpetrusha
ms.author: ronpet
manager: wpickett
ms.workload: dotnet
ms.openlocfilehash: 11739d35d3a6d845feb1f6d9544f6ea347a9942d
ms.sourcegitcommit: c0dd436f6f8f44dc80dc43b07f6841a00b74b23f
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 01/19/2018
---
# <a name="copying-and-pinning"></a><span data-ttu-id="8d5d4-102">Kopírování a přichycování</span><span class="sxs-lookup"><span data-stu-id="8d5d4-102">Copying and Pinning</span></span>
<span data-ttu-id="8d5d4-103">Při zařazování dat, spolupráce vláken můžete zkopírovat nebo kód pin se zařazené data.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-103">When marshaling data, the interop marshaler can copy or pin the data being marshaled.</span></span> <span data-ttu-id="8d5d4-104">Kopírování dat umístí kopii dat z jednoho umístění paměti v jiném umístění paměti.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-104">Copying the data places a copy of data from one memory location in another memory location.</span></span> <span data-ttu-id="8d5d4-105">Následující obrázek znázorňuje rozdíly mezi kopírování typ hodnoty a kopírování typu předaná odkaz ze spravované na nespravované paměti.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-105">The following illustration shows the differences between copying a value type and copying a type passed by reference from managed to unmanaged memory.</span></span>  
  
 <span data-ttu-id="8d5d4-106">![Hodnota předaná podle hodnoty a podle reference typy](../../../docs/framework/interop/media/interopmarshalcopy.gif "interopmarshalcopy")</span><span class="sxs-lookup"><span data-stu-id="8d5d4-106">![Value types passed by value and by reference](../../../docs/framework/interop/media/interopmarshalcopy.gif "interopmarshalcopy")</span></span>  
<span data-ttu-id="8d5d4-107">Typy hodnot předán podle hodnoty a podle reference</span><span class="sxs-lookup"><span data-stu-id="8d5d4-107">Value types passed by value and by reference</span></span>  
  
 <span data-ttu-id="8d5d4-108">Metoda argumenty předaná hodnota přeuspořádány na nespravovaný kód jako hodnoty v zásobníku.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-108">Method arguments passed by value are marshaled to unmanaged code as values on the stack.</span></span> <span data-ttu-id="8d5d4-109">Proces kopírování je SMB direct.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-109">The copying process is direct.</span></span> <span data-ttu-id="8d5d4-110">Argumenty předávané odkazem jsou předány jako ukazatele v zásobníku.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-110">Arguments passed by reference are passed as pointers on the stack.</span></span> <span data-ttu-id="8d5d4-111">Odkazové typy jsou předávány také podle hodnoty a podle reference.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-111">Reference types are also passed by value and by reference.</span></span> <span data-ttu-id="8d5d4-112">Jak ukazuje následující obrázek, předaná hodnota odkazové typy jsou zkopírovány nebo připnutý.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-112">As the following illustration shows, reference types passed by value are either copied or pinned.</span></span>  
  
 <span data-ttu-id="8d5d4-113">![Zprostředkovatel komunikace s objekty COM](../../../docs/framework/interop/media/interopmarshalpin.gif "interopmarshalpin")</span><span class="sxs-lookup"><span data-stu-id="8d5d4-113">![COM interop](../../../docs/framework/interop/media/interopmarshalpin.gif "interopmarshalpin")</span></span>  
<span data-ttu-id="8d5d4-114">Odkazové typy předán podle hodnoty a podle reference</span><span class="sxs-lookup"><span data-stu-id="8d5d4-114">Reference types passed by value and by reference</span></span>  
  
 <span data-ttu-id="8d5d4-115">Připnutí dočasně zamkne dat v aktuálním umístění paměti, proto je zachování z se přemístění podle common language runtime systém uvolňování paměti.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-115">Pinning temporarily locks the data in its current memory location, thus keeping it from being relocated by the common language runtime's garbage collector.</span></span> <span data-ttu-id="8d5d4-116">Zařazování PIN kódy dat snížit režii kopírování a vylepšují výkon.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-116">The marshaler pins data to reduce the overhead of copying and enhance performance.</span></span> <span data-ttu-id="8d5d4-117">Typ dat určuje, zda je zkopírovat nebo připnuté během procesu zařazování.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-117">The type of the data determines whether it is copied or pinned during the marshaling process.</span></span>  <span data-ttu-id="8d5d4-118">Připnutí se provádí automaticky při zařazování pro objekty, jako <xref:System.String>, ale můžete také ručně připnout paměti pomocí <xref:System.Runtime.InteropServices.GCHandle> třídy.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-118">Pinning is automatically performed during marshaling for objects such as <xref:System.String>, however you can also manually pin memory using the <xref:System.Runtime.InteropServices.GCHandle> class.</span></span>  
  
## <a name="formatted-blittable-classes"></a><span data-ttu-id="8d5d4-119">Formátovaný přenositelné třídy</span><span class="sxs-lookup"><span data-stu-id="8d5d4-119">Formatted Blittable Classes</span></span>  
 <span data-ttu-id="8d5d4-120">Formátovaný [přenositelné](../../../docs/framework/interop/blittable-and-non-blittable-types.md) třídy opravili rozložení (ve formátu) a běžné reprezentace dat v obou spravovaných a nespravovaných paměti.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-120">Formatted [blittable](../../../docs/framework/interop/blittable-and-non-blittable-types.md) classes have fixed layout (formatted) and common data representation in both managed and unmanaged memory.</span></span> <span data-ttu-id="8d5d4-121">Pokud tyto typy vyžadují kódování, ukazatel na objekt v haldě je předán volaného přímo.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-121">When these types require marshaling, a pointer to the object in the heap is passed to the callee directly.</span></span> <span data-ttu-id="8d5d4-122">Volaného můžete změnit obsah umístění v paměti se na ně odkazovat ukazatele.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-122">The callee can change the contents of the memory location being referenced by the pointer.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="8d5d4-123">Obsah paměti můžete změnit volaného, pokud parametr je označen jako Out či vstup/výstup. Naproti tomu volaného byste neměli Změna obsahu, pokud parametr je nastaven na zařazování jako v což je výchozí nastavení pro formátovaný přenositelné typy.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-123">The callee can change the memory contents if the parameter is marked Out or In/Out. In contrast, the callee should avoid changing the contents when the parameter is set to marshal as In, which is the default for formatted blittable types.</span></span> <span data-ttu-id="8d5d4-124">Úprava objektu v generuje problémy, když se stejnou třídu exportují do knihovny typů a použít k volání mezi apartment.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-124">Modifying an In object generates problems when the same class is exported to a type library and used to make cross-apartment calls.</span></span>  
  
## <a name="formatted-non-blittable-classes"></a><span data-ttu-id="8d5d4-125">Formátovaný nepřenositelné třídy</span><span class="sxs-lookup"><span data-stu-id="8d5d4-125">Formatted Non-Blittable Classes</span></span>  
 <span data-ttu-id="8d5d4-126">Formátovaný [nepřenositelné](../../../docs/framework/interop/blittable-and-non-blittable-types.md) třídy opravili rozložení (ve formátu), ale reprezentace dat se liší v spravovanými a nespravovanými paměti.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-126">Formatted [non-blittable](../../../docs/framework/interop/blittable-and-non-blittable-types.md) classes have fixed layout (formatted) but the data representation is different in managed and unmanaged memory.</span></span> <span data-ttu-id="8d5d4-127">Data můžete vyžadovat transformace za následujících podmínek:</span><span class="sxs-lookup"><span data-stu-id="8d5d4-127">The data can require transformation under the following conditions:</span></span>  
  
-   <span data-ttu-id="8d5d4-128">Pokud je třída nepřenositelné zařazena pomocí hodnoty, obdrží volaného ukazatel na kopii datovou strukturu.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-128">If a non-blittable class is marshaled by value, the callee receives a pointer to a copy of the data structure.</span></span>  
  
-   <span data-ttu-id="8d5d4-129">Pokud je třída nepřenositelné zařazena pomocí odkazu, obdrží volaného ukazatel na ukazatel na kopii datovou strukturu.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-129">If a non-blittable class is marshaled by reference, the callee receives a pointer to a pointer to a copy of the data structure.</span></span>  
  
-   <span data-ttu-id="8d5d4-130">Pokud <xref:System.Runtime.InteropServices.InAttribute> nastavený atribut, tato kopie je vždy inicializovat stavem instance zařazování podle potřeby.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-130">If the <xref:System.Runtime.InteropServices.InAttribute> attribute is set, this copy is always initialized with the instance's state, marshaling as necessary.</span></span>  
  
-   <span data-ttu-id="8d5d4-131">Pokud <xref:System.Runtime.InteropServices.OutAttribute> nastavený atribut, stav se vždy zkopíruje zpět na instanci na return zařazování podle potřeby.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-131">If the <xref:System.Runtime.InteropServices.OutAttribute> attribute is set, the state is always copied back to the instance on return, marshaling as necessary.</span></span>  
  
-   <span data-ttu-id="8d5d4-132">Pokud oba **InAttribute** a **OutAttribute** jsou nastavené, jsou požadovány obě kopie.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-132">If both **InAttribute** and **OutAttribute** are set, both copies are required.</span></span> <span data-ttu-id="8d5d4-133">Pokud je vynechán buď atribut, můžete optimalizovat zařazování odstraněním buď kopírování.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-133">If either attribute is omitted, the marshaler can optimize by eliminating either copy.</span></span>  
  
## <a name="reference-types"></a><span data-ttu-id="8d5d4-134">Typy odkazů</span><span class="sxs-lookup"><span data-stu-id="8d5d4-134">Reference Types</span></span>  
 <span data-ttu-id="8d5d4-135">Hodnotou nebo odkazem, může být předán odkazové typy.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-135">Reference types can be passed by value or by reference.</span></span> <span data-ttu-id="8d5d4-136">Když jsou předávány podle hodnoty, je ukazatel typu předán v zásobníku.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-136">When they are passed by value, a pointer to the type is passed on the stack.</span></span> <span data-ttu-id="8d5d4-137">Při předání odkazem, je předaná ukazatel na ukazatel na typ na zásobníku.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-137">When passed by reference, a pointer to a pointer to the type is passed on the stack.</span></span>  
  
 <span data-ttu-id="8d5d4-138">Typy odkazů mít podmíněného následující chování:</span><span class="sxs-lookup"><span data-stu-id="8d5d4-138">Reference types have the following conditional behavior:</span></span>  
  
-   <span data-ttu-id="8d5d4-139">Pokud je předaná hodnota typu odkazu a má členy nepřenositelné typy, typy se převedou dvakrát:</span><span class="sxs-lookup"><span data-stu-id="8d5d4-139">If a reference type is passed by value and it has members of non-blittable types, the types are converted twice:</span></span>  
  
    -   <span data-ttu-id="8d5d4-140">Když je argument předaný nespravované straně.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-140">When an argument is passed to the unmanaged side.</span></span>  
  
    -   <span data-ttu-id="8d5d4-141">Při návratu z volání.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-141">On return from the call.</span></span>  
  
     <span data-ttu-id="8d5d4-142">Aby se zabránilo zbytečně kopírování a převodu tyto typy jsou zařazené jako v parametry.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-142">To avoid unnecessarily copying and conversion, these types are marshaled as In parameters.</span></span> <span data-ttu-id="8d5d4-143">Musíte explicitně použít **InAttribute** a **OutAttribute** atributy pro argument volajícího a podívejte se změny provedené volaného.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-143">You must explicitly apply the **InAttribute** and **OutAttribute** attributes to an argument for the caller to see changes made by the callee.</span></span>  
  
-   <span data-ttu-id="8d5d4-144">Pokud je předaná hodnota typu odkazu a má pouze členové přenositelné typy, může být připnutý při zařazování a všechny změny provedené volaného na členy typu jsou vidět volající.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-144">If a reference type is passed by value and it has only members of blittable types, it can be pinned during marshaling and any changes made to the members of the type by the callee are seen by the caller.</span></span> <span data-ttu-id="8d5d4-145">Použít **InAttribute** a **OutAttribute** explicitně, pokud chcete toto chování.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-145">Apply **InAttribute** and **OutAttribute** explicitly if you want this behavior.</span></span> <span data-ttu-id="8d5d4-146">Bez těchto směrovou atributů spolupráce vláken neexportuje směrovou informace ke knihovně typů (exportuje jako v, což je výchozí hodnota). to může způsobit problémy s zařazování mezi apartment COM.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-146">Without these directional attributes, the interop marshaler does not export directional information to the type library (it exports as In, which is the default) and this can cause problems with COM cross-apartment marshaling.</span></span>  
  
-   <span data-ttu-id="8d5d4-147">Pokud typ odkazu je předán odkazem, ji budou zařazována jako vstup/výstup ve výchozím nastavení.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-147">If a reference type is passed by reference, it will be marshaled as In/Out by default.</span></span>  
  
## <a name="systemstring-and-systemtextstringbuilder"></a><span data-ttu-id="8d5d4-148">System.String a objektu System.Text.StringBuilder.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-148">System.String and System.Text.StringBuilder</span></span>  
 <span data-ttu-id="8d5d4-149">Pokud data je zařazen do nespravovaného kódu hodnotou nebo odkazem, zařazování obvykle zkopíruje data na sekundární vyrovnávací paměti (pravděpodobně převodu znakové sady během kopírování) a předá volaného odkaz do vyrovnávací paměti.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-149">When data is marshaled to unmanaged code by value or by reference, the marshaler typically copies the data to a secondary buffer (possibly converting character sets during the copy) and passes a reference to the buffer to the callee.</span></span> <span data-ttu-id="8d5d4-150">Pokud je odkaz **BSTR** přidělený **SysAllocString**, odkaz na vždycky se přidělí s **CoTaskMemAlloc**.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-150">Unless the reference is a **BSTR** allocated with **SysAllocString**, the reference is always allocated with **CoTaskMemAlloc**.</span></span>  
  
 <span data-ttu-id="8d5d4-151">Jako optimalizace když buď typ řetězce je zařazena pomocí hodnoty (například řetězec znaků Unicode), zařazování předá volaného přímé ukazatel na spravované řetězce v vnitřní vyrovnávací paměť Unicode namísto kopírování do nové vyrovnávací paměti.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-151">As an optimization when either string type is marshaled by value (such as a Unicode character string), the marshaler passes the callee a direct pointer to managed strings in the internal Unicode buffer instead of copying it to a new buffer.</span></span>  
  
> [!CAUTION]
>  <span data-ttu-id="8d5d4-152">Pokud řetězec, je předaná hodnota, musí volaného nikdy změnit odkaz předaná zařazování.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-152">When a string is passed by value, the callee must never alter the reference passed by the marshaler.</span></span> <span data-ttu-id="8d5d4-153">Díky tomu může dojít k poškození spravovaná halda.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-153">Doing so can corrupt the managed heap.</span></span>  
  
 <span data-ttu-id="8d5d4-154">Když <xref:System.String?displayProperty=nameWithType> je předán odkazem, zařazování zkopíruje obsah řetězec do vyrovnávací paměti sekundární před uskutečněním hovoru.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-154">When a <xref:System.String?displayProperty=nameWithType> is passed by reference, the marshaler copies the contents the string to a secondary buffer before making the call.</span></span> <span data-ttu-id="8d5d4-155">Pak zkopíruje obsah vyrovnávací paměti do nového řetězce pro návrat z volání.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-155">It then copies the contents of the buffer into a new string on return from the call.</span></span> <span data-ttu-id="8d5d4-156">Tento postup zajišťuje, že neměnné spravovaný řetězec zůstává beze změny.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-156">This technique ensures that the immutable managed string remains unaltered.</span></span>  
  
 <span data-ttu-id="8d5d4-157">Když <xref:System.Text.StringBuilder?displayProperty=nameWithType> je předaná hodnota, předává vláken a odkaz na vnitřní vyrovnávací paměť **StringBuilder** přímo na volající.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-157">When a <xref:System.Text.StringBuilder?displayProperty=nameWithType> is passed by value, the marshaler passes a reference to the internal buffer of the **StringBuilder** directly to the caller.</span></span> <span data-ttu-id="8d5d4-158">Volající a volaný, musíte souhlasit na velikost vyrovnávací paměti.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-158">The caller and callee must agree on the size of the buffer.</span></span> <span data-ttu-id="8d5d4-159">Volající zodpovídá za vytvoření **StringBuilder** odpovídající délky.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-159">The caller is responsible for creating a **StringBuilder** of adequate length.</span></span> <span data-ttu-id="8d5d4-160">Volaného nutné provést nezbytná opatření k zajištění, že není přetečení vyrovnávací paměti.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-160">The callee must take the necessary precautions to ensure that the buffer is not overrun.</span></span> <span data-ttu-id="8d5d4-161">**StringBuilder** je výjimkou pravidla, která odkazové typy předaná hodnota jsou předány jako parametry ve výchozím nastavení.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-161">**StringBuilder** is an exception to the rule that reference types passed by value are passed as In parameters by default.</span></span> <span data-ttu-id="8d5d4-162">Je to vždy předáno jako vstup/výstup.</span><span class="sxs-lookup"><span data-stu-id="8d5d4-162">It is always passed as In/Out.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="8d5d4-163">Viz také</span><span class="sxs-lookup"><span data-stu-id="8d5d4-163">See Also</span></span>  
 [<span data-ttu-id="8d5d4-164">Výchozí chování zařazování</span><span class="sxs-lookup"><span data-stu-id="8d5d4-164">Default Marshaling Behavior</span></span>](../../../docs/framework/interop/default-marshaling-behavior.md)  
 [<span data-ttu-id="8d5d4-165">Správa paměti s spolupráce zařazování vláken</span><span class="sxs-lookup"><span data-stu-id="8d5d4-165">Memory Management with the Interop Marshaler</span></span>](http://msdn.microsoft.com/library/417206ce-ee3e-4619-9529-0c0b686c7bee)  
 [<span data-ttu-id="8d5d4-166">Směrovou atributy</span><span class="sxs-lookup"><span data-stu-id="8d5d4-166">Directional Attributes</span></span>](http://msdn.microsoft.com/library/241ac5b5-928e-4969-8f58-1dbc048f9ea2)  
 [<span data-ttu-id="8d5d4-167">Zařazování spolupráce</span><span class="sxs-lookup"><span data-stu-id="8d5d4-167">Interop Marshaling</span></span>](../../../docs/framework/interop/interop-marshaling.md)
