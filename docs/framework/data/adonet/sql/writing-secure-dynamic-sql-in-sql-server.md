---
title: "Zápis zabezpečené dynamické SQL v systému SQL Server"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-ado
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: df5512b0-c249-40d2-82f9-f9a2ce6665bc
caps.latest.revision: "9"
author: douglaslMS
ms.author: douglasl
manager: craigg
ms.workload: dotnet
ms.openlocfilehash: 41c396bf2101e54adb1608f938c702ff7663cb1d
ms.sourcegitcommit: ed26cfef4e18f6d93ab822d8c29f902cff3519d1
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 01/17/2018
---
# <a name="writing-secure-dynamic-sql-in-sql-server"></a><span data-ttu-id="50ec2-102">Zápis zabezpečené dynamické SQL v systému SQL Server</span><span class="sxs-lookup"><span data-stu-id="50ec2-102">Writing Secure Dynamic SQL in SQL Server</span></span>
<span data-ttu-id="50ec2-103">Injektáž SQL je proces, pomocí kterého uživatel se zlými úmysly zadá příkazy jazyka Transact-SQL místo platný vstup.</span><span class="sxs-lookup"><span data-stu-id="50ec2-103">SQL Injection is the process by which a malicious user enters Transact-SQL statements instead of valid input.</span></span> <span data-ttu-id="50ec2-104">Pokud vstup je předán přímo k serveru bez ověřování a aplikace nechtěně spustí kód vložený, se útoku může dojít k poškození nebo zničení data.</span><span class="sxs-lookup"><span data-stu-id="50ec2-104">If the input is passed directly to the server without being validated and if the application inadvertently executes the injected code, the attack has the potential to damage or destroy data.</span></span>  
  
 <span data-ttu-id="50ec2-105">Všechny příkazy SQL procedury měla být kontrolována chyb zabezpečení, vkládání, protože SQL Server provede všechny syntakticky dotazy, které obdrží.</span><span class="sxs-lookup"><span data-stu-id="50ec2-105">Any procedure that constructs SQL statements should be reviewed for injection vulnerabilities because SQL Server will execute all syntactically valid queries that it receives.</span></span> <span data-ttu-id="50ec2-106">Zkušený a určené útočník smí uživatel manipulovat i parametrizované data.</span><span class="sxs-lookup"><span data-stu-id="50ec2-106">Even parameterized data can be manipulated by a skilled and determined attacker.</span></span> <span data-ttu-id="50ec2-107">Pokud používáte dynamické SQL, nezapomeňte Parametrizace příkazech a nikdy nezahrne hodnoty parametrů přímo do řetězce dotazu.</span><span class="sxs-lookup"><span data-stu-id="50ec2-107">If you use dynamic SQL, be sure to parameterize your commands, and never include parameter values directly into the query string.</span></span>  
  
## <a name="anatomy-of-a-sql-injection-attack"></a><span data-ttu-id="50ec2-108">Anatomie útok prostřednictvím injektáže SQL</span><span class="sxs-lookup"><span data-stu-id="50ec2-108">Anatomy of a SQL Injection Attack</span></span>  
 <span data-ttu-id="50ec2-109">Proces vkládání funguje tak, že předčasně ukončení textový řetězec a připojení nového příkazu.</span><span class="sxs-lookup"><span data-stu-id="50ec2-109">The injection process works by prematurely terminating a text string and appending a new command.</span></span> <span data-ttu-id="50ec2-110">Protože vložení příkazu může mít další řetězce, přidá se k němu předtím, než se spustí, malefactor ukončí vloženého řetězec s komentář označte "–".</span><span class="sxs-lookup"><span data-stu-id="50ec2-110">Because the inserted command may have additional strings appended to it before it is executed, the malefactor terminates the injected string with a comment mark "--".</span></span> <span data-ttu-id="50ec2-111">Následující text je ignorován v době provedení.</span><span class="sxs-lookup"><span data-stu-id="50ec2-111">Subsequent text is ignored at execution time.</span></span> <span data-ttu-id="50ec2-112">Můžete vložit více příkazů pomocí středníkem (;) oddělovač.</span><span class="sxs-lookup"><span data-stu-id="50ec2-112">Multiple commands can be inserted using a semicolon (;) delimiter.</span></span>  
  
 <span data-ttu-id="50ec2-113">Tak dlouho, dokud vloženého kódu SQL je syntakticky správný, manipulaci nelze zjistit prostřednictvím kódu programu.</span><span class="sxs-lookup"><span data-stu-id="50ec2-113">As long as injected SQL code is syntactically correct, tampering cannot be detected programmatically.</span></span> <span data-ttu-id="50ec2-114">Proto musíte ověřit všechny vstup uživatele a pečlivě zkontrolujte kód, který spouští sestavené příkazy SQL na serveru, který používáte.</span><span class="sxs-lookup"><span data-stu-id="50ec2-114">Therefore, you must validate all user input and carefully review code that executes constructed SQL commands in the server that you are using.</span></span> <span data-ttu-id="50ec2-115">Nikdy řetězení vstup uživatele, který není ověřen.</span><span class="sxs-lookup"><span data-stu-id="50ec2-115">Never concatenate user input that is not validated.</span></span> <span data-ttu-id="50ec2-116">Zřetězení řetězců je primární bod položky skriptu.</span><span class="sxs-lookup"><span data-stu-id="50ec2-116">String concatenation is the primary point of entry for script injection.</span></span>  
  
 <span data-ttu-id="50ec2-117">Zde jsou některé užitečné pokyny:</span><span class="sxs-lookup"><span data-stu-id="50ec2-117">Here are some helpful guidelines:</span></span>  
  
-   <span data-ttu-id="50ec2-118">Nikdy sestavení příkazy jazyka Transact-SQL přímo z vstup uživatele; pomocí uložených procedur ověření vstupu uživatele.</span><span class="sxs-lookup"><span data-stu-id="50ec2-118">Never build Transact-SQL statements directly from user input; use stored procedures to validate user input.</span></span>  
  
-   <span data-ttu-id="50ec2-119">Ověřte vstup uživatele tak, že testování typ, délku, formát a rozsah.</span><span class="sxs-lookup"><span data-stu-id="50ec2-119">Validate user input by testing type, length, format, and range.</span></span> <span data-ttu-id="50ec2-120">Abyste se vyhnuli názvy systému nebo funkce REPLACE(), abyste se vyhnuli libovolný znak v řetězci, použijte funkci QUOTENAME() Transact-SQL.</span><span class="sxs-lookup"><span data-stu-id="50ec2-120">Use the Transact-SQL QUOTENAME() function to escape system names or the REPLACE() function to escape any character in a string.</span></span>  
  
-   <span data-ttu-id="50ec2-121">Implementujte několik vrstev ověření v jednotlivých vrstvách vaší aplikace.</span><span class="sxs-lookup"><span data-stu-id="50ec2-121">Implement multiple layers of validation in each tier of your application.</span></span>  
  
-   <span data-ttu-id="50ec2-122">Testování velikosti a datový typ vstupu a vynutit odpovídající omezení.</span><span class="sxs-lookup"><span data-stu-id="50ec2-122">Test the size and data type of input and enforce appropriate limits.</span></span> <span data-ttu-id="50ec2-123">To může pomoct zabránit záměrné přetečení zásobníku.</span><span class="sxs-lookup"><span data-stu-id="50ec2-123">This can help prevent deliberate buffer overruns.</span></span>  
  
-   <span data-ttu-id="50ec2-124">Zkušební obsah proměnných řetězce a přijímat pouze očekávaných hodnot.</span><span class="sxs-lookup"><span data-stu-id="50ec2-124">Test the content of string variables and accept only expected values.</span></span> <span data-ttu-id="50ec2-125">Odmítněte položky, které obsahují binární data, řídicí sekvence a komentář znaky.</span><span class="sxs-lookup"><span data-stu-id="50ec2-125">Reject entries that contain binary data, escape sequences, and comment characters.</span></span>  
  
-   <span data-ttu-id="50ec2-126">Při práci s dokumenty XML, ověřte všechna data pro její schéma, jak je zadán.</span><span class="sxs-lookup"><span data-stu-id="50ec2-126">When you are working with XML documents, validate all data against its schema as it is entered.</span></span>  
  
-   <span data-ttu-id="50ec2-127">V prostředích s víceúrovňových by měla být ověřena všechna data před jejich příchodu do zóny důvěryhodných serverů.</span><span class="sxs-lookup"><span data-stu-id="50ec2-127">In multi-tiered environments, all data should be validated before admission to the trusted zone.</span></span>  
  
-   <span data-ttu-id="50ec2-128">Nepřijímají následujících řetězců v polích, ze které souboru názvy konstruovat: AUX, CLOCK$, COM1 až COM8, CON, konfigurace$, LPT1 LPT8, NUL a PRN.</span><span class="sxs-lookup"><span data-stu-id="50ec2-128">Do not accept the following strings in fields from which file names can be constructed: AUX, CLOCK$, COM1 through COM8, CON, CONFIG$, LPT1 through LPT8, NUL, and PRN.</span></span>  
  
-   <span data-ttu-id="50ec2-129">Použití <xref:System.Data.SqlClient.SqlParameter> objektů pomocí uložené procedury a příkazy pro ověřování typu kontrolu a délka.</span><span class="sxs-lookup"><span data-stu-id="50ec2-129">Use <xref:System.Data.SqlClient.SqlParameter> objects with stored procedures and commands to provide type checking and length validation.</span></span>  
  
-   <span data-ttu-id="50ec2-130">Použití <xref:System.Text.RegularExpressions.Regex> výrazy v kódu klienta pro filtrování neplatné znaky.</span><span class="sxs-lookup"><span data-stu-id="50ec2-130">Use <xref:System.Text.RegularExpressions.Regex> expressions in client code to filter invalid characters.</span></span>  
  
## <a name="dynamic-sql-strategies"></a><span data-ttu-id="50ec2-131">Strategie dynamické SQL</span><span class="sxs-lookup"><span data-stu-id="50ec2-131">Dynamic SQL Strategies</span></span>  
 <span data-ttu-id="50ec2-132">Provádění dynamicky vytvoří příkazů SQL v vaší procedurální kód zalomení řetězu vlastnictví způsobuje systému SQL Server zkontrolujte oprávnění volajícího u těchto objektů přistupuje dynamické SQL.</span><span class="sxs-lookup"><span data-stu-id="50ec2-132">Executing dynamically created SQL statements in your procedural code breaks the ownership chain, causing SQL Server to check the permissions of the caller against the objects being accessed by the dynamic SQL.</span></span>  
  
 <span data-ttu-id="50ec2-133">Metody pro uživatelům udělen přístup k datům pomocí uložené procedury a uživatelem definované funkce, které jsou spouštěny dynamické SQL má systém SQL Server.</span><span class="sxs-lookup"><span data-stu-id="50ec2-133">SQL Server has methods for granting users access to data using stored procedures and user-defined functions that execute dynamic SQL.</span></span>  
  
-   <span data-ttu-id="50ec2-134">Pomocí jazyka Transact-SQL AS provést zosobnění klauzule, jak je popsáno v [přizpůsobení oprávnění s zosobnění v systému SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="50ec2-134">Using impersonation with the Transact-SQL EXECUTE AS clause, as described in [Customizing Permissions with Impersonation in SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md).</span></span>  
  
-   <span data-ttu-id="50ec2-135">Podepisování uložené procedury s certifikáty, jak je popsáno v [podepisování uložené procedury v systému SQL Server](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="50ec2-135">Signing stored procedures with certificates, as described in [Signing Stored Procedures in SQL Server](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md).</span></span>  
  
### <a name="execute-as"></a><span data-ttu-id="50ec2-136">SPUŠTĚNÍ AS</span><span class="sxs-lookup"><span data-stu-id="50ec2-136">EXECUTE AS</span></span>  
 <span data-ttu-id="50ec2-137">Spustit jako klauzule nahradí oprávnění volajícího s od uživatele zadané v EXECUTE AS klauzule.</span><span class="sxs-lookup"><span data-stu-id="50ec2-137">The EXECUTE AS clause replaces the permissions of the caller with that of the user specified in the EXECUTE AS clause.</span></span> <span data-ttu-id="50ec2-138">Vnořené uložené procedury nebo aktivační události spustit v kontextu zabezpečení uživatele proxy serveru.</span><span class="sxs-lookup"><span data-stu-id="50ec2-138">Nested stored procedures or triggers execute under the security context of the proxy user.</span></span> <span data-ttu-id="50ec2-139">To může dojít k narušení aplikace, které spoléhají na zabezpečení na úrovni řádků nebo vyžadovat auditování.</span><span class="sxs-lookup"><span data-stu-id="50ec2-139">This can break applications that rely on row-level security or require auditing.</span></span> <span data-ttu-id="50ec2-140">Některé funkce, které vrátí identitu uživatele, vrátí uživatele zadaného v EXECUTE AS klauzule, není původní volající.</span><span class="sxs-lookup"><span data-stu-id="50ec2-140">Some functions that return the identity of the user return the user specified in the EXECUTE AS clause, not the original caller.</span></span> <span data-ttu-id="50ec2-141">Kontext spuštění je vrátit zpět na původní volající pouze po spuštění procedury nebo při vydání příkazu vrátit.</span><span class="sxs-lookup"><span data-stu-id="50ec2-141">Execution context is reverted to the original caller only after execution of the procedure or when a REVERT statement is issued.</span></span>  
  
### <a name="certificate-signing"></a><span data-ttu-id="50ec2-142">Podepisování certifikátu</span><span class="sxs-lookup"><span data-stu-id="50ec2-142">Certificate Signing</span></span>  
 <span data-ttu-id="50ec2-143">Když provede uložené procedury, která má byla podepsána pomocí certifikátu, oprávnění udělená uživateli certifikát jsou sloučeny s těmi, která volajícího.</span><span class="sxs-lookup"><span data-stu-id="50ec2-143">When a stored procedure that has been signed with a certificate executes, the permissions granted to the certificate user are merged with those of the caller.</span></span> <span data-ttu-id="50ec2-144">Kontext spuštění zůstává stejná; Uživatel certifikát není zosobnit volající.</span><span class="sxs-lookup"><span data-stu-id="50ec2-144">The execution context remains the same; the certificate user does not impersonate the caller.</span></span> <span data-ttu-id="50ec2-145">Podepisování uložené procedury, vyžaduje několik kroků k implementaci.</span><span class="sxs-lookup"><span data-stu-id="50ec2-145">Signing stored procedures requires several steps to implement.</span></span> <span data-ttu-id="50ec2-146">Pokaždé, když se mění podle postupu, musí být znovu podepisovat.</span><span class="sxs-lookup"><span data-stu-id="50ec2-146">Each time the procedure is modified, it must be re-signed.</span></span>  
  
### <a name="cross-database-access"></a><span data-ttu-id="50ec2-147">Mezi přístup k databázi</span><span class="sxs-lookup"><span data-stu-id="50ec2-147">Cross Database Access</span></span>  
 <span data-ttu-id="50ec2-148">Řetězení mezidatabázové vlastnictví nefunguje, pokud je v případech, kde jsou vykonány dynamicky vytvořený příkazů SQL.</span><span class="sxs-lookup"><span data-stu-id="50ec2-148">Cross-database ownership chaining does not work in cases where dynamically created SQL statements are executed.</span></span> <span data-ttu-id="50ec2-149">Můžete obejít v [!INCLUDE[ssNoVersion](../../../../../includes/ssnoversion-md.md)] vytvořením uložené procedury, která přistupuje k datům v jiné databázi a podepisování postup s certifikátem, který již existuje v obou databází.</span><span class="sxs-lookup"><span data-stu-id="50ec2-149">You can work around this in [!INCLUDE[ssNoVersion](../../../../../includes/ssnoversion-md.md)] by creating a stored procedure that accesses data in another database and signing the procedure with a certificate that exists in both databases.</span></span> <span data-ttu-id="50ec2-150">To umožňuje uživatelům přístup k databázi prostředky využívané třídou postup bez toho, abyste jim přístup k databázi nebo oprávnění.</span><span class="sxs-lookup"><span data-stu-id="50ec2-150">This gives users access to the database resources used by the procedure without granting them database access or permissions.</span></span>  
  
## <a name="external-resources"></a><span data-ttu-id="50ec2-151">Externí zdroje</span><span class="sxs-lookup"><span data-stu-id="50ec2-151">External Resources</span></span>  
 <span data-ttu-id="50ec2-152">Další informace najdete v následujících zdrojích informací.</span><span class="sxs-lookup"><span data-stu-id="50ec2-152">For more information, see the following resources.</span></span>  
  
|<span data-ttu-id="50ec2-153">Prostředek</span><span class="sxs-lookup"><span data-stu-id="50ec2-153">Resource</span></span>|<span data-ttu-id="50ec2-154">Popis</span><span class="sxs-lookup"><span data-stu-id="50ec2-154">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="50ec2-155">[Uložené procedury](http://go.microsoft.com/fwlink/?LinkId=98233) a [Injektáž SQL](http://go.microsoft.com/fwlink/?LinkId=98234) v Online knihách serveru SQL</span><span class="sxs-lookup"><span data-stu-id="50ec2-155">[Stored Procedures](http://go.microsoft.com/fwlink/?LinkId=98233) and [SQL Injection](http://go.microsoft.com/fwlink/?LinkId=98234) in SQL Server Books Online</span></span>|<span data-ttu-id="50ec2-156">Témata popisují, jak vytvořit uložené procedury a jak funguje Injektáž SQL.</span><span class="sxs-lookup"><span data-stu-id="50ec2-156">Topics describe how to create stored procedures and how SQL Injection works.</span></span>|  
|<span data-ttu-id="50ec2-157">[Nové útoky zkrácení SQL a jak se vyhnout jejich](http://msdn.microsoft.com/msdnmag/issues/06/11/SQLSecurity/) v časopise MSDN.</span><span class="sxs-lookup"><span data-stu-id="50ec2-157">[New SQL Truncation Attacks And How To Avoid Them](http://msdn.microsoft.com/msdnmag/issues/06/11/SQLSecurity/) in MSDN Magazine.</span></span>|<span data-ttu-id="50ec2-158">Popisuje, jak lze omezit znaky a řetězce, Injektáž SQL a úpravy pomocí zkrácení útoky.</span><span class="sxs-lookup"><span data-stu-id="50ec2-158">Describes how to delimit characters and strings, SQL injection, and modification by  truncation attacks.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="50ec2-159">Viz také</span><span class="sxs-lookup"><span data-stu-id="50ec2-159">See Also</span></span>  
 [<span data-ttu-id="50ec2-160">Zabezpečení aplikací ADO.NET</span><span class="sxs-lookup"><span data-stu-id="50ec2-160">Securing ADO.NET Applications</span></span>](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)  
 [<span data-ttu-id="50ec2-161">Přehled zabezpečení SQL Serveru</span><span class="sxs-lookup"><span data-stu-id="50ec2-161">Overview of SQL Server Security</span></span>](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)  
 [<span data-ttu-id="50ec2-162">Scénáře zabezpečení aplikací na SQL Serveru</span><span class="sxs-lookup"><span data-stu-id="50ec2-162">Application Security Scenarios in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)  
 [<span data-ttu-id="50ec2-163">Správa oprávnění pomocí uložených procedur na SQL Serveru</span><span class="sxs-lookup"><span data-stu-id="50ec2-163">Managing Permissions with Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)  
 [<span data-ttu-id="50ec2-164">Podepisování uložených procedur na SQL Serveru</span><span class="sxs-lookup"><span data-stu-id="50ec2-164">Signing Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md)  
 [<span data-ttu-id="50ec2-165">Přizpůsobení oprávnění se zosobněním na SQL Serveru</span><span class="sxs-lookup"><span data-stu-id="50ec2-165">Customizing Permissions with Impersonation in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md)  
 [<span data-ttu-id="50ec2-166">ADO.NET spravované zprostředkovatelé a středisku pro vývojáře datové sady</span><span class="sxs-lookup"><span data-stu-id="50ec2-166">ADO.NET Managed Providers and DataSet Developer Center</span></span>](http://go.microsoft.com/fwlink/?LinkId=217917)
